pipeline {
  agent any

  stages {
    stage('Checkout') {
      steps {
        git url: 'git@gitlab.com:bennirah/api-ansible.git',
            branch: 'main',
            credentialsId: 'jetkins'
      }
    }

    stage('Run Ansible') {
       steps {
            sshagent(credentials: ['ansible-hosts-key']) {
            sh '''
                set -e
                cd "$WORKSPACE"
                export ANSIBLE_HOST_KEY_CHECKING=False
                ansible-playbook -i ansible/inventory.yml ansible/main.yml
            '''
    }
    }
  }

  post {
    success { echo ' Déploiement réussi !' }
    failure { echo ' Échec du déploiement !' }
  }
}
